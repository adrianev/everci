<apex:page standardController="ServiceAppointment" extensions="GenerarAlbaranController"
	showHeader="true" sidebar="false">
	<apex:stylesheet value="{!URLFOR($Resource.VF_CSS_General)}"/>
	<apex:includeScript value="{!$Resource.jQuery}" />

	<apex:actionStatus id="iconoCargando"
		onStart="document.getElementById('{!$Component.mainForm}').style.display='none';"
		onStop="document.getElementById('{!$Component.mainForm}').style.display='block';">
		<apex:facet name="start">
			<apex:outputPanel styleClass="panelFondo">
				<div class="contenedorCargando">Cargando...</div>
			</apex:outputPanel>
		</apex:facet>
	</apex:actionStatus>

	<apex:form id="mainForm">

		<apex:sectionHeader title="Generación de Albarán"
			subtitle="{!if(cita != null, cita.AppointmentNumber, '')}" />

		<apex:pageBlock id="formulario" title="Generar Albarán">
			<apex:pageMessages id="mensajes" />
			<apex:pageBlockButtons id="botones">
				<apex:commandButton value="<< Cancelar"
					title="Cancelar"
					action="{!volver}" immediate="true"
					status="iconoCargando" rerender="mainForm"/>
				<apex:commandButton value="Guardar >>"
					title="Generar Albarán"
					action="{!guardarAlbaran}"
					status="iconoCargando" rerender="mainForm"
					rendered="{!visibleGuardar}"/>
				<apex:commandButton value="Guardar y Enviar >>"
					title="Generar Albarán y Enviarlo por Correo Electrónico"
					action="{!guardarYEnviarAlbaran}"
					status="iconoCargando" rerender="mainForm"
					rendered="{!visibleGuardar && !esReclamacion}"/>
			</apex:pageBlockButtons>

			<c:Detalle_Caso atrCaso="{!caso}" rendered="{!tipoCaso == 1}" />
			<c:Detalle_B2B_B2B2C atrCase="{!caso}" atrAccount="{!cuenta}"
				atrB2C="{!esB2C}" rendered="{!tipoCaso == 2}" />

			<apex:pageBlockSection collapsible="false" columns="2" showHeader="false">
				<apex:inputField label="Contacto: Nombre"  value="{!caso.CAS_TXT_Nombre__c}" />
				<apex:inputField label="Contacto: Apellidos"  value="{!caso.CAS_TXT_Apellidos__c}" />
				<apex:inputField label="Contacto: Correo Electrónico" value="{!caso.CAS_EMA_Solicitud_Email__c}" />
				<apex:outputField label="Idioma Cliente" value="{!cuenta.CUE_SEL_Idioma__c}" />
			</apex:pageBlockSection>

			<apex:pageBlockSection collapsible="false" columns="2"
				title="Datos del {!$ObjectType.WorkOrder.label}">
				<apex:outputField value="{!ordenTrabajo.WorkOrderNumber}" />
				<apex:outputField value="{!ordenTrabajo.OTR_SEL_Gremio__c}" />
				<apex:outputField value="{!ordenTrabajo.Status}" />
				<apex:outputField value="{!ordenTrabajo.OTR_CAS_Urgente__c}" />
				<apex:outputText label="Profesional" value="{!ordenTrabajo.OTR_FOR_Codigo_Profesional__c}" />
				<apex:outputField label="Base Imponible" value="{!ordenTrabajo.OTR_RES_Facturar_Cliente_AI__c}" />
				<apex:outputText label="I.V.A." value="{!impuesto}%" />
				<apex:outputField label="Importe Total" value="{!ordenTrabajo.OTR_RES_Facturar_Cliente_DI__c}" />
			</apex:pageBlockSection>

			<apex:pageBlockSection collapsible="false" columns="2"
				title="Datos de la {!$ObjectType.ServiceAppointment.label}">
				<apex:outputField value="{!cita.AppointmentNumber}" />
				<apex:outputField value="{!cita.Status}" />
			</apex:pageBlockSection>

			<apex:pageBlockSection collapsible="false" columns="2" title="Firmas">
				<apex:outputText label="Firmado por Cliente" value="{!if(firmadoCliente,'Sí','No')}" />
				<apex:outputText label="Firmado por Profesional" value="{!if(firmadoProfesional,'Sí','No')}" />
				<apex:commandButton value="Capturar Firma Cliente" title="Capturar Firma CLiente" styleClass="celdaDerecha"
					action="{!firmaCliente}" status="iconoCargando" rendered="{!!bloquearAcciones}" rerender="mainForm"/>
				<apex:commandButton value="Capturar Firma Profesional" title="Capturar Firma Profesional" styleClass="celdaDerecha"
					action="{!firmaProfesional}" status="iconoCargando" rendered="{!!bloquearAcciones}" rerender="mainForm"/>
			</apex:pageBlockSection>

			<apex:pageBlockSection title="Detalle de trabajos" collapsible="false"
				columns="1">
				<apex:pageBlockTable value="{!listaPartidas}" var="partida"
					title="Detalle de trabajos">
					<apex:column headerValue="Código de Baremo" value="{!partida.PAR_TXT_Baremo_Codigo__c}" />
					<apex:column headerValue="Descripción" value="{!partida.Description}" />
					<apex:column headerValue="Unidades" value="{!partida.PAR_NUM_Unidades__c}"/>
					<apex:column headerValue="Precio Unitario" value="{!partida.PAR_FOR_Precio_Unitario_Venta_Cli__c}"/>
					<apex:column headerValue="Importe" value="{!partida.PAR_DIV_Cargar_Cliente_AI__c}"/>
				</apex:pageBlockTable>
			</apex:pageBlockSection>
		</apex:pageBlock>
	</apex:form>
</apex:page>